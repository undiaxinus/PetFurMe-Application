import React, { useEffect, useState } from 'react';
import { View, Text, TouchableOpacity, StyleSheet, Animated, Platform, Alert, AsyncStorage } from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { useNavigation, useRoute } from '@react-navigation/native';
import { useNotifications } from '../context/NotificationContext';

const BottomNavigation = ({ activeScreen = 'HomePage', user_id, isVerified: propIsVerified }) => {
  const navigation = useNavigation();
  const route = useRoute();
  const { hasUnreadNotifications, checkUnreadNotifications } = useNotifications();
  const [isVerified, setIsVerified] = useState(propIsVerified || false);
  
  // Check verification status from AsyncStorage
  useEffect(() => {
    const checkVerificationStatus = async () => {
      try {
        const storedVerification = await AsyncStorage.getItem('isVerified');
        if (storedVerification !== null) {
          setIsVerified(JSON.parse(storedVerification));
        }
      } catch (error) {
        console.error('Error reading verification status:', error);
      }
    };

    checkVerificationStatus();
  }, []);

  // Update local state when prop changes
  useEffect(() => {
    setIsVerified(propIsVerified);
  }, [propIsVerified]);

  // Check for unread notifications when component mounts
  useEffect(() => {
    checkUnreadNotifications();
  }, []);

  // If user_id is not passed as prop, try to get it from route params
  const currentUserId = user_id || route.params?.user_id;

  // Add this function to normalize screen names
  const normalizeScreenName = (screenName) => {
    const screenMap = {
      'ChatSupport': 'ChatScreen',
      'Chat': 'ChatScreen',
      'FAQ': 'Help',
      'Appointments': 'Appointment',
      // Add other screen name mappings if needed
    };
    return screenMap[screenName] || screenName;
  };

  // Update the activeScreen check to use normalized names
  const currentScreen = normalizeScreenName(activeScreen || route.name);

  // Create animation values with useRef to persist across re-renders
  const animations = React.useRef({
    HomePage: new Animated.Value(currentScreen === 'HomePage' ? 1 : 0),
    ChatScreen: new Animated.Value(currentScreen === 'ChatScreen' ? 1 : 0),
    NotificationScreen: new Animated.Value(currentScreen === 'NotificationScreen' ? 1 : 0),
    Help: new Animated.Value(currentScreen === 'Help' ? 1 : 0),
    Appointment: new Animated.Value(currentScreen === 'Appointment' ? 1 : 0),
  }).current;

  // Reset animations when activeScreen changes
  React.useEffect(() => {
    // Reset all animations first
    Object.keys(animations).forEach(screen => {
      Animated.timing(animations[screen], {
        toValue: 0,
        duration: 150,
        useNativeDriver: true,
      }).start();
    });

    // Animate the active screen
    if (animations[currentScreen]) {
      Animated.timing(animations[currentScreen], {
        toValue: 1,
        duration: 200,
        useNativeDriver: true,
      }).start();
    }
  }, [currentScreen, animations]);

  const handleNavigation = (screen) => {
    try {
      if (!currentUserId && screen !== 'HomePage') {
        navigation.navigate('LoginScreen');
        return;
      }
      
      navigation.navigate(screen, { 
        user_id: currentUserId,
        timestamp: Date.now()
      });
    } catch (error) {
      console.error('Navigation error:', error);
    }
  };

  const getTabStyle = (screen) => {
    return {
      transform: [
        {
          scale: animations[screen].interpolate({
            inputRange: [0, 1],
            outputRange: [1, 1.05],
          }),
        }
      ],
      opacity: animations[screen].interpolate({
        inputRange: [0, 1],
        outputRange: [0.7, 1],
      }),
    };
  };

  const styles = StyleSheet.create({
    container: {
      position: 'sticky',
      bottom: 0,
      left: 0,
      right: 0,
      backgroundColor: 'transparent',
      height: Platform.OS === 'ios' ? 90 : 75,
      zIndex: 1000,
      elevation: 8,
      borderTopWidth: 0,
    },
    background: {
      position: 'absolute',
      bottom: 0,
      left: 0,
      right: 0,
      height: '100%',
      backgroundColor: 'rgba(255, 255, 255, 0.98)',
      borderTopLeftRadius: 20,
      borderTopRightRadius: 20,
      shadowColor: '#000',
      shadowOffset: {
        width: 0,
        height: -4,
      },
      shadowOpacity: 0.1,
      shadowRadius: 8,
      elevation: 10,
      borderTopWidth: 0,
      marginTop: -1,
    },
    bottomNav: {
      flexDirection: 'row',
      justifyContent: 'space-around',
      alignItems: 'center',
      height: '100%',
      paddingHorizontal: 10,
      paddingBottom: Platform.OS === 'ios' ? 20 : 10,
    },
    navItem: {
      alignItems: 'center',
      justifyContent: 'center',
      height: 50,
      width: '20%',
      paddingHorizontal: 2,
    },
    homeItem: {
      marginTop: -15,
    },
    homeIconContainer: {
      backgroundColor: '#f0e6f7',
      padding: 12,
      borderRadius: 30,
      borderWidth: 2,
      borderColor: '#8146C1',
      elevation: 4,
      shadowColor: '#8146C1',
      shadowOffset: {
        width: 0,
        height: 2,
      },
      shadowOpacity: 0.25,
      shadowRadius: 3.84,
    },
    iconContainer: {
      position: 'relative',
      alignItems: 'center',
      justifyContent: 'center',
      width: '100%',
    },
    navText: {
      fontSize: 10,
      color: '#8146C1',
      marginTop: 2,
      textAlign: 'center',
      opacity: 0.8,
    },
    activeText: {
      fontWeight: '600',
      opacity: 1,
      color: '#8146C1',
    },
    notificationBadge: {
      position: 'absolute',
      right: -2,
      top: -2,
      backgroundColor: '#FF4444',
      borderRadius: 8,
      width: 16,
      height: 16,
      justifyContent: 'center',
      alignItems: 'center',
      borderWidth: 1.5,
      borderColor: '#fff',
    },
    badgeText: {
      color: '#FFF',
      fontSize: 10,
      fontWeight: 'bold',
    },
    disabledNavItem: {
      opacity: 0.5,
    },
  });

  return (
    <View style={styles.container}>
      <View style={styles.background} />
      <View style={styles.bottomNav}>
        {/* Navigation Items */}
        {[
          { screen: 'ChatScreen', icon: 'chatbubble', label: 'Chat' },
          { screen: 'Appointment', icon: 'calendar', label: 'Appointments', requiresVerification: true },
          { screen: 'HomePage', icon: 'paw', label: 'Home' },
          { screen: 'NotificationScreen', icon: 'notifications', label: 'Notifications' },
          { screen: 'Help', icon: 'help-circle', label: 'FAQ' }
        ].map(({ screen, icon, label, requiresVerification }) => (
          <TouchableOpacity 
            key={screen}
            style={[
              styles.navItem,
              screen === 'HomePage' && styles.homeItem,
              requiresVerification && !isVerified && styles.disabledNavItem
            ]}
            onPress={() => {
              if (requiresVerification && !isVerified) {
                Alert.alert(
                  "Verification Required",
                  "Your account needs to be verified before accessing this feature.",
                  [{ text: "OK", onPress: () => console.log("OK Pressed") }]
                );
              } else {
                handleNavigation(screen);
              }
            }}
          >
            <Animated.View style={[
              styles.iconContainer, 
              getTabStyle(screen),
              screen === 'HomePage' && styles.homeIconContainer
            ]}>
              <Ionicons 
                name={currentScreen === screen ? icon : `${icon}-outline`}
                size={screen === 'HomePage' ? 28 : 22}
                color={currentScreen === screen ? '#8146C1' : '#8146C1'}
              />
              {screen === 'NotificationScreen' && hasUnreadNotifications && (
                <View style={styles.notificationBadge}>
                  <Text style={styles.badgeText}>â€¢</Text>
                </View>
              )}
            </Animated.View>
            <Text 
              style={[
                styles.navText, 
                currentScreen === screen && styles.activeText,
                requiresVerification && !isVerified && { color: '#CCCCCC' },
                screen === 'NotificationScreen' && { fontSize: 9 },
              ]} 
              numberOfLines={1}
              ellipsizeMode="tail"
            >
              {label}
            </Text>
          </TouchableOpacity>
        ))}
      </View>
    </View>
  );
};

export default BottomNavigation;